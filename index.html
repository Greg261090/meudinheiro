<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finan√ßas">
    <meta name="theme-color" content="#2563eb">
    <title>Controle Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            overscroll-behavior: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        input, select, button, textarea {
            font-size: 16px !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Estado inicial
        const categoriasDefault = ['Alimenta√ß√£o', 'Transporte', 'Moradia', 'Sa√∫de', 'Educa√ß√£o', 'Lazer', 'Outros'];
        
        let state = {
            activeTab: 'resumo',
            activeMenu: 'inicio',
            showModal: false,
            modalType: null,
            showConfig: !localStorage.getItem('sheetId'),
            sheetId: localStorage.getItem('sheetId') || '',
            transacoes: JSON.parse(localStorage.getItem('transacoes') || '[]'),
            categorias: JSON.parse(localStorage.getItem('categorias') || JSON.stringify(categoriasDefault)),
            cartoes: JSON.parse(localStorage.getItem('cartoes') || '[]'),
            editando: null,
            novaTransacao: {
                tipo: 'despesa',
                categoria: '',
                valor: '',
                data: new Date().toISOString().split('T')[0],
                descricao: '',
                cartao: 'dinheiro',
                parcelado: false,
                parcelas: 1,
                parcelaAtual: 1
            },
            novaCategoria: { nome: '', icone: 'üì¶', cor: 'bg-gray-500' },
            novoCartao: { nome: '', limite: '', diaFechamento: 1, diaVencimento: 10, bandeira: 'Visa' }
        };

        const icones = ['üçΩÔ∏è', 'üöó', 'üè†', '‚ù§Ô∏è', 'üìö', 'üéÆ', '‚úàÔ∏è', 'üõí', '‚òï', 'üé¨', 'üí™', 'üëï', 'üí∞', 'üì±', '‚ö°', 'üí°', 'üé®', 'üîß', 'üì¶'];
        const cores = [
            'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 
            'bg-blue-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 
            'bg-gray-500', 'bg-teal-500', 'bg-cyan-500', 'bg-lime-500'
        ];
        const bandeiras = ['Visa', 'Mastercard', 'Elo', 'American Express', 'Hipercard', 'Outro'];

        function salvarDados() {
            localStorage.setItem('transacoes', JSON.stringify(state.transacoes));
            localStorage.setItem('categorias', JSON.stringify(state.categorias));
            localStorage.setItem('cartoes', JSON.stringify(state.cartoes));
        }

        function calcularPeriodo() {
            const hoje = new Date();
            const dia = hoje.getDate();
            let inicio, fim;
            
            if (dia >= 15) {
                inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 15);
                fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 14);
            } else {
                inicio = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 15);
                fim = new Date(hoje.getFullYear(), hoje.getMonth(), 14);
            }
            
            return {
                inicio: inicio.toISOString().split('T')[0],
                fim: fim.toISOString().split('T')[0],
                texto: `${inicio.getDate()} ${inicio.toLocaleDateString('pt-BR', {month: 'short'})} - ${fim.getDate()} ${fim.toLocaleDateString('pt-BR', {month: 'short'})}`
            };
        }

        async function carregarDados() {
            if (!state.sheetId) return;
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${state.sheetId}/gviz/tq?tqx=out:json`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                const rows = json.table.rows;
                const dados = rows.slice(1).map(row => ({
                    id: row.c[0]?.v || Date.now(),
                    tipo: row.c[1]?.v || 'despesa',
                    categoria: row.c[2]?.v || 'Outros',
                    valor: row.c[3]?.v || '0',
                    data: row.c[4]?.v || new Date().toISOString().split('T')[0],
                    descricao: row.c[5]?.v || '',
                    cartao: row.c[6]?.v || 'dinheiro',
                    parcelado: row.c[7]?.v === 'true',
                    parcelas: parseInt(row.c[8]?.v) || 1,
                    parcelaAtual: parseInt(row.c[9]?.v) || 1
                }));
                
                state.transacoes = dados;
                salvarDados();
                state.showConfig = false;
                render();
            } catch (error) {
                alert('Erro ao carregar dados. Verifique se a planilha est√° p√∫blica.');
            }
        }

        function adicionarTransacao() {
            if (!state.novaTransacao.valor || !state.novaTransacao.descricao || !state.novaTransacao.categoria) {
                alert('Preencha todos os campos obrigat√≥rios');
                return;
            }

            if (state.editando !== null) {
                state.transacoes[state.editando] = {
                    ...state.transacoes[state.editando],
                    ...state.novaTransacao
                };
                state.editando = null;
            } else {
                const nova = {
                    id: Date.now(),
                    ...state.novaTransacao
                };
                state.transacoes.push(nova);
            }

            salvarDados();
            fecharModal();
            render();
        }

        function excluirTransacao(index) {
            if (confirm('Deseja realmente excluir esta transa√ß√£o?')) {
                state.transacoes.splice(index, 1);
                salvarDados();
                render();
            }
        }

        function editarTransacao(index) {
            state.editando = index;
            state.novaTransacao = { ...state.transacoes[index] };
            state.modalType = 'transacao';
            state.showModal = true;
            render();
        }

        function adicionarCategoria() {
            if (!state.novaCategoria.nome) {
                alert('Digite o nome da categoria');
                return;
            }

            if (state.editando !== null) {
                state.categorias[state.editando] = { ...state.novaCategoria };
                state.editando = null;
            } else {
                state.categorias.push({ ...state.novaCategoria });
            }

            salvarDados();
            state.novaCategoria = { nome: '', icone: 'üì¶', cor: 'bg-gray-500' };
            fecharModal();
            render();
        }

        function excluirCategoria(index) {
            if (confirm('Deseja realmente excluir esta categoria?')) {
                state.categorias.splice(index, 1);
                salvarDados();
                render();
            }
        }

        function editarCategoria(index) {
            state.editando = index;
            state.novaCategoria = { ...state.categorias[index] };
            state.modalType = 'categoria';
            state.showModal = true;
            render();
        }

        function adicionarCartao() {
            if (!state.novoCartao.nome || !state.novoCartao.limite) {
                alert('Preencha todos os campos');
                return;
            }

            if (state.editando !== null) {
                state.cartoes[state.editando] = { ...state.novoCartao };
                state.editando = null;
            } else {
                state.cartoes.push({ id: Date.now(), ...state.novoCartao });
            }

            salvarDados();
            state.novoCartao = { nome: '', limite: '', diaFechamento: 1, diaVencimento: 10, bandeira: 'Visa' };
            fecharModal();
            render();
        }

        function excluirCartao(index) {
            if (confirm('Deseja realmente excluir este cart√£o?')) {
                state.cartoes.splice(index, 1);
                salvarDados();
                render();
            }
        }

        function editarCartao(index) {
            state.editando = index;
            state.novoCartao = { ...state.cartoes[index] };
            state.modalType = 'cartao';
            state.showModal = true;
            render();
        }

        function getCategoriaData(nomeCategoria) {
            const cat = state.categorias.find(c => c.nome === nomeCategoria);
            return cat || { nome: nomeCategoria, icone: 'üì¶', cor: 'bg-gray-500' };
        }

        function formatarData(data) {
            const d = new Date(data + 'T00:00:00');
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
        }

        function formatarMoeda(valor) {
            return parseFloat(valor).toFixed(2);
        }

        function abrirModal(tipo) {
            state.modalType = tipo;
            state.showModal = true;
            state.editando = null;
            
            if (tipo === 'transacao') {
                state.novaTransacao = {
                    tipo: 'despesa',
                    categoria: state.categorias[0]?.nome || '',
                    valor: '',
                    data: new Date().toISOString().split('T')[0],
                    descricao: '',
                    cartao: 'dinheiro',
                    parcelado: false,
                    parcelas: 1,
                    parcelaAtual: 1
                };
            }
            render();
        }

        function fecharModal() {
            state.showModal = false;
            state.modalType = null;
            state.editando = null;
            render();
        }

        function exportarTransacoes() {
            const texto = 'ID\tTipo\tCategoria\tValor\tData\tDescri√ß√£o\tCart√£o\tParcelado\tParcelas\tParcelaAtual\n' +
                state.transacoes.map(t => 
                    `${t.id}\t${t.tipo}\t${t.categoria}\t${t.valor}\t${t.data}\t${t.descricao}\t${t.cartao || 'dinheiro'}\t${t.parcelado || false}\t${t.parcelas || 1}\t${t.parcelaAtual || 1}`
                ).join('\n');
            
            navigator.clipboard.writeText(texto).then(() => {
                alert('Todas as transa√ß√µes foram copiadas! Cole na planilha Google.');
            });
        }

        function render() {
            const periodo = calcularPeriodo();
            const transacoesPeriodo = state.transacoes.filter(t => 
                t.data >= periodo.inicio && t.data <= periodo.fim
            );

            const receitas = transacoesPeriodo
                .filter(t => t.tipo === 'receita')
                .reduce((sum, t) => sum + parseFloat(t.valor), 0);
            
            const despesas = transacoesPeriodo
                .filter(t => t.tipo === 'despesa')
                .reduce((sum, t) => sum + parseFloat(t.valor), 0);
            
            const saldo = receitas - despesas;

            const despesasPorCategoria = transacoesPeriodo
                .filter(t => t.tipo === 'despesa')
                .reduce((acc, t) => {
                    acc[t.categoria] = (acc[t.categoria] || 0) + parseFloat(t.valor);
                    return acc;
                }, {});

            const despesasPorCartao = transacoesPeriodo
                .filter(t => t.tipo === 'despesa' && t.cartao !== 'dinheiro')
                .reduce((acc, t) => {
                    acc[t.cartao] = (acc[t.cartao] || 0) + parseFloat(t.valor);
                    return acc;
                }, {});

            const app = document.getElementById('app');
            
            if (state.showConfig) {
                app.innerHTML = renderConfig();
                return;
            }

            let content = '';

            if (state.activeMenu === 'inicio') {
                content = renderInicio(periodo, saldo, receitas, despesas, transacoesPeriodo, despesasPorCategoria);
            } else if (state.activeMenu === 'cartoes') {
                content = renderCartoes(despesasPorCartao);
            } else if (state.activeMenu === 'categorias') {
                content = renderCategorias();
            } else if (state.activeMenu === 'mais') {
                content = renderMais();
            }

            app.innerHTML = `
                <div class="max-w-md mx-auto bg-gradient-to-b from-blue-600 to-blue-800 min-h-screen pb-20">
                    ${content}
                    
                    ${state.activeMenu === 'inicio' ? `
                        <button onclick="window.abrirModal('transacao')" class="fixed bottom-24 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg text-3xl z-40">
                            ‚ûï
                        </button>
                    ` : ''}

                    ${renderBottomNav()}
                </div>

                ${state.showModal ? renderModal() : ''}
            `;
        }

        function renderConfig() {
            return `
                <div class="max-w-md mx-auto bg-gradient-to-b from-blue-600 to-blue-800 min-h-screen p-6 flex items-center justify-center">
                    <div class="bg-white rounded-3xl p-8 w-full">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Configurar Google Sheets</h2>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID da Planilha Google</label>
                            <input
                                type="text"
                                id="sheetIdInput"
                                value="${state.sheetId}"
                                placeholder="Cole o ID da planilha aqui"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                            />
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 text-sm">
                            <p class="font-semibold mb-2">üìã Cabe√ßalhos necess√°rios:</p>
                            <code class="bg-white px-2 py-1 rounded text-xs block">ID | Tipo | Categoria | Valor | Data | Descri√ß√£o | Cart√£o | Parcelado | Parcelas | ParcelaAtual</code>
                        </div>

                        <button
                            onclick="window.conectarPlanilha()"
                            class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 mb-3"
                        >
                            Conectar Planilha
                        </button>

                        <button
                            onclick="window.usarSemPlanilha()"
                            class="w-full text-gray-600 py-3 rounded-xl font-medium hover:bg-gray-100"
                        >
                            Usar sem planilha
                        </button>
                    </div>
                </div>
            `;
        }

        function renderInicio(periodo, saldo, receitas, despesas, transacoes, despesasPorCategoria) {
            return `
                <div class="p-6 text-white">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-2xl font-bold">üí∞ Minhas Finan√ßas</h1>
                            <div class="flex items-center gap-2 mt-1 text-blue-100">
                                <span>üìÖ</span>
                                <span class="text-sm">${periodo.texto}</span>
                            </div>
                        </div>
                        <button onclick="window.abrirConfig()" class="p-2 bg-blue-500 rounded-full hover:bg-blue-400">
                            ‚öôÔ∏è
                        </button>
                    </div>

                    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 border border-white/20">
                        <p class="text-blue-100 text-sm mb-2">Saldo Atual</p>
                        <p class="text-4xl font-bold mb-6">R$ ${formatarMoeda(saldo)}</p>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span>üìà</span>
                                    <span class="text-xs text-blue-100">Receitas</span>
                                </div>
                                <p class="text-lg font-semibold text-green-300">R$ ${formatarMoeda(receitas)}</p>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span>üìâ</span>
                                    <span class="text-xs text-blue-100">Despesas</span>
                                </div>
                                <p class="text-lg font-semibold text-red-300">R$ ${formatarMoeda(despesas)}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-t-3xl min-h-screen pt-6 px-6">
                    <div class="flex gap-4 mb-6 border-b border-gray-200">
                        <button onclick="window.setTab('resumo')" class="pb-3 px-2 font-medium ${state.activeTab === 'resumo' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}">
                            Resumo
                        </button>
                        <button onclick="window.setTab('transacoes')" class="pb-3 px-2 font-medium ${state.activeTab === 'transacoes' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}">
                            Transa√ß√µes
                        </button>
                    </div>

                    ${state.activeTab === 'resumo' ? 
                        renderResumo(despesasPorCategoria, despesas) : 
                        renderTransacoes(transacoes)
                    }
                </div>
            `;
        }

        function renderResumo(despesasPorCategoria, totalDespesas) {
            if (Object.keys(despesasPorCategoria).length === 0) {
                return '<p class="text-gray-500 text-center py-8">Nenhuma despesa no per√≠odo</p>';
            }

            return `
                <div class="space-y-4 pb-24">
                    <h3 class="font-semibold text-gray-800 mb-3">Gastos por Categoria</h3>
                    ${Object.entries(despesasPorCategoria).map(([categoria, valor]) => {
                        const catData = getCategoriaData(categoria);
                        const percentual = (valor / totalDespesas * 100).toFixed(0);
                        return `
                            <div class="bg-white rounded-2xl p-4 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="${catData.cor} p-2 rounded-xl text-2xl">${catData.icone}</div>
                                        <span class="font-medium text-gray-800">${categoria}</span>
                                    </div>
                                    <span class="font-semibold text-gray-800">R$ ${formatarMoeda(valor)}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                        <div class="${catData.cor} h-2 rounded-full" style="width: ${percentual}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-500">${percentual}%</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderTransacoes(transacoes) {
            if (transacoes.length === 0) {
                return '<p class="text-gray-500 text-center py-8">Nenhuma transa√ß√£o no per√≠odo</p>';
            }

            return `
                <div class="space-y-3 pb-24">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">Transa√ß√µes</h3>
                        <button onclick="window.exportarTransacoes()" class="text-sm text-blue-600 font-medium">
                            üì§ Exportar
                        </button>
                    </div>
                    ${transacoes.map((t, idx) => {
                        const catData = getCategoriaData(t.categoria);
                        return `
                            <div class="bg-white rounded-2xl p-4 shadow-sm">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="${t.tipo === 'receita' ? 'bg-green-100' : 'bg-red-100'} p-2 rounded-xl">
                                            ${t.tipo === 'receita' ? 'üìà' : 'üìâ'}
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-800">${t.descricao}</p>
                                            <p class="text-sm text-gray-500">${formatarData(t.data)} ‚Ä¢ ${t.categoria}</p>
                                            ${t.cartao !== 'dinheiro' ? `<p class="text-xs text-blue-600">üí≥ ${t.cartao}</p>` : ''}
                                            ${t.parcelado ? `<p class="text-xs text-purple-600">${t.parcelaAtual}/${t.parcelas}x</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold ${t.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}">
                                            ${t.tipo === 'receita' ? '+' : '-'}R$ ${formatarMoeda(t.valor)}
                                        </span>
                                        <button onclick="window.editarTransacao(${state.transacoes.indexOf(t)})" class="text-blue-600 text-xl">‚úèÔ∏è</button>
                                        <button onclick="window.excluirTransacao(${state.transacoes.indexOf(t)})" class="text-red-600 text-xl">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCartoes(despesasPorCartao) {
            return `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl font-bold text-white">üí≥ Cart√µes</h1>
                        <button onclick="window.abrirModal('cartao')" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-medium">
                            ‚ûï Adicionar
                        </button>
                    </div>

                    <div class="space-y-4">
                        ${state.cartoes.length === 0 ? 
                            '<p class="text-white text-center py-8">Nenhum cart√£o cadastrado</p>' :
                            state.cartoes.map((cartao, idx) => {
                                const gasto = despesasPorCartao[cartao.nome] || 0;
                                const disponivel = parseFloat(cartao.limite) - gasto;
                                const percentual = (gasto / parseFloat(cartao.limite) * 100).toFixed(0);
                                
                                return `
                                    <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 border border-white/20">
                                        <div class="flex items-center justify-between mb-4">
                                            <div>
                                                <p class="text-white font-bold text-lg">${cartao.nome}</p>
                                                <p class="text-blue-100 text-sm">${cartao.bandeira}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="window.editarCartao(${idx})" class="text-white text-xl">‚úèÔ∏è</button>
                                                <button onclick="window.excluirCartao(${idx})" class="text-red-300 text-xl">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <div class="flex justify-between text-blue-100 text-sm mb-2">
                                                <span>Gasto</span>
                                                <span>R$ ${formatarMoeda(gasto)} / R$ ${formatarMoeda(cartao.limite)}</span>
                                            </div>
                                            <div class="bg-white/20 rounded-full h-3">
                                                <div class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full" style="width: ${percentual}%"></div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-3 gap-4 text-sm">
                                            <div>
                                                <p class="text-blue-100">Dispon√≠vel</p>
                                                <p class="text-white font-semibold">R$ ${formatarMoeda(disponivel)}</p>
                                            </div>
                                            <div>
                                                <p class="text-blue-100">Fechamento</p>
                                                <p class="text-white font-semibold">Dia ${cartao.diaFechamento}</p>
                                            </div>
                                            <div>
                                                <p class="text-blue-100">Vencimento</p>
                                                <p class="text-white font-semibold">Dia ${cartao.diaVencimento}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;
        }

        function renderCategorias() {
            return `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl font-bold text-white">üìÇ Categorias</h1>
                        <button onclick="window.abrirModal('categoria')" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-medium">
                            ‚ûï Adicionar
                        </button>
                    </div>

                    <div class="bg-white rounded-3xl p-4">
                        <div class="space-y-3">
                            ${state.categorias.map((cat, idx) => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="${cat.cor} p-2 rounded-xl text-2xl">${cat.icone}</div>
                                        <span class="font-medium text-gray-800">${cat.nome}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="window.editarCategoria(${idx})" class="text-blue-600 text-xl">‚úèÔ∏è</button>
                                        <button onclick="window.excluirCategoria(${idx})" class="text-red-600 text-xl">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `